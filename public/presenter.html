<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MentiClone - Presenter</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <header>
        <div class="logo">MentiClone Presenter</div>
        <div>
            <span id="connection-count" style="font-weight: 600; color: var(--success-color);">0 users</span>
        </div>
    </header>

    <div class="container">
        <div class="dashboard-grid">

            <!-- Left Sidebar: Slide Queue -->
            <div class="slide-sidebar">
                <div class="sidebar-header">
                    <span>Slides</span>
                    <button class="icon-btn" onclick="focusAddSlide()" title="Add Slide"><i
                            class="fas fa-plus"></i></button>
                </div>
                <div class="slide-list" id="slide-list">
                    <!-- Slides injected here -->
                </div>
            </div>

            <!-- Main Content: Live Results -->
            <div class="main-content">
                <div class="preview-card">
                    <div class="preview-header">
                        <h2 id="result-title">Question Title</h2>
                    </div>

                    <!-- Text Results -->
                    <div id="text-results" class="hidden" style="width: 100%; display: flex; justify-content: center;">
                        <ul id="response-list" class="response-list"></ul>
                    </div>

                    <!-- Poll Results -->
                    <div id="poll-results" class="hidden poll-container">
                        <!-- Poll bars injected here -->
                    </div>

                    <!-- Word Cloud Results -->
                    <div id="wordcloud-results" class="hidden word-cloud">
                        <!-- Words injected here -->
                    </div>
                </div>

                <!-- Navigation -->
                <div style="display: flex; justify-content: center; gap: 1rem; padding: 1rem 0;">
                    <button class="secondary" onclick="prevSlide()" style="width: auto;"><i
                            class="fas fa-chevron-left"></i> Previous</button>
                    <button class="secondary" onclick="nextSlide()" style="width: auto;">Next <i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <!-- Right Sidebar: Controls -->
            <div class="controls-sidebar">

                <!-- QR Code -->
                <div class="qr-section">
                    <div class="qr-container" id="qrcode"></div>
                    <div class="join-url" id="join-url"></div>
                </div>

                <div class="card">
                    <h3>Session Controls</h3>
                    <button id="toggle-active-btn" onclick="toggleActive()" style="margin-bottom: 10px;">Pause
                        Session</button>
                    <button class="danger" onclick="clearResponses()">Clear Results</button>
                </div>

                <div class="card">
                    <h3>Add Slide</h3>
                    <input type="text" id="new-question" placeholder="Question text...">
                    <select id="new-type">
                        <option value="text">Text Q&A</option>
                        <option value="poll">Poll</option>
                        <option value="wordcloud">Word Cloud</option>
                    </select>

                    <!-- Poll Options Config -->
                    <div id="poll-options-config" class="hidden"
                        style="margin-top: 10px; border-top: 1px solid #333; padding-top: 10px;">
                        <label style="font-size: 0.8rem; color: #aaa;">Poll Options:</label>
                        <div id="poll-options-list">
                            <input type="text" class="poll-option-input" placeholder="Option 1"
                                style="margin-bottom: 5px;">
                            <input type="text" class="poll-option-input" placeholder="Option 2"
                                style="margin-bottom: 5px;">
                        </div>
                        <button class="secondary" onclick="addOptionInput()"
                            style="padding: 5px; font-size: 0.8rem; margin-bottom: 10px;">+ Add Option</button>
                    </div>

                    <button onclick="submitNewSlide()" style="margin-top: 5px;">Add Slide</button>
                </div>

                <div class="card">
                    <h3>Blocklist</h3>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="block-input" placeholder="Block word..." style="margin: 0;">
                        <button onclick="addBlockWord()" style="width: auto; padding: 0 15px;">Add</button>
                    </div>
                    <div id="blocklist-container"
                        style="max-height: 150px; overflow-y: auto; margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast">Notification</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentState = {};

        // Generate QR Code
        const joinUrl = window.location.origin + "/student.html";
        new QRCode(document.getElementById("qrcode"), {
            text: joinUrl,
            width: 128,
            height: 128,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        document.getElementById("join-url").innerText = joinUrl;

        // Poll Options Logic
        const newTypeSelect = document.getElementById('new-type');
        const pollOptionsConfig = document.getElementById('poll-options-config');

        newTypeSelect.addEventListener('change', () => {
            if (newTypeSelect.value === 'poll') {
                pollOptionsConfig.classList.remove('hidden');
            } else {
                pollOptionsConfig.classList.add('hidden');
            }
        });

        function addOptionInput() {
            const container = document.getElementById('poll-options-list');
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = `Option ${container.children.length + 1}`;
            input.className = 'poll-option-input';
            input.style.marginBottom = '5px';
            container.appendChild(input);
        }

        socket.on('state_update', (state) => {
            currentState = state;
            render(state);
        });

        socket.on('connect', () => {
            // Request initial state if needed
        });

        function render(state) {
            // Update Active Button
            const toggleBtn = document.getElementById('toggle-active-btn');
            toggleBtn.innerText = state.isActive ? "Pause Session" : "Resume Session";
            toggleBtn.className = state.isActive ? "" : "secondary";

            // Render Slide List
            renderSlideList(state);

            // Render Current Slide View
            const currentSlide = state.currentSlide;
            document.getElementById('result-title').innerText = currentSlide.question;

            document.getElementById('text-results').classList.add('hidden');
            document.getElementById('poll-results').classList.add('hidden');
            document.getElementById('wordcloud-results').classList.add('hidden');

            if (currentSlide.type === 'text') {
                document.getElementById('text-results').classList.remove('hidden');
                renderTextResults(state.responses);
            } else if (currentSlide.type === 'poll') {
                document.getElementById('poll-results').classList.remove('hidden');
                renderPollResults(state.pollCounts, currentSlide.options);
            } else if (currentSlide.type === 'wordcloud') {
                document.getElementById('wordcloud-results').classList.remove('hidden');
                renderWordCloud(state.responses);
            }

            // Render Blocklist
            renderBlocklist(state.customBlocklist);
        }

        function renderSlideList(state) {
            const slideList = document.getElementById('slide-list');
            slideList.innerHTML = '';
            state.slides.forEach((slide, index) => {
                const div = document.createElement('div');
                div.className = `slide-item ${index === state.currentSlideIndex ? 'active' : ''}`;
                div.onclick = (e) => {
                    if (e.target.closest('.slide-actions')) return;
                    setSlide(index);
                };

                div.innerHTML = `
                    <span class="slide-number">${index + 1}</span>
                    <div class="slide-content">
                        <h4>${slide.question}</h4>
                        <p>${slide.type.toUpperCase()}</p>
                    </div>
                    <div class="slide-actions">
                        <button class="icon-btn" onclick="moveSlide(${index}, -1)" title="Move Up"><i class="fas fa-arrow-up"></i></button>
                        <button class="icon-btn" onclick="moveSlide(${index}, 1)" title="Move Down"><i class="fas fa-arrow-down"></i></button>
                        <button class="icon-btn delete" onclick="deleteSlide(${index})" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                slideList.appendChild(div);
            });
        }

        function renderTextResults(responses) {
            const list = document.getElementById('response-list');
            list.innerHTML = '';
            responses.forEach(r => {
                const li = document.createElement('li');
                li.className = 'response-item';
                li.innerText = r.content;
                list.appendChild(li);
            });
        }

        function renderPollResults(counts, options) {
            const container = document.getElementById('poll-results');
            container.innerHTML = '';

            const total = Object.values(counts).reduce((a, b) => a + b, 0);

            Object.keys(options).forEach(opt => {
                const count = counts[opt] || 0;
                const percent = total === 0 ? 0 : (count / total) * 100;

                const wrapper = document.createElement('div');
                wrapper.className = 'poll-bar-wrapper';
                wrapper.innerHTML = `
                    <div style="width: 100%;">
                        <div class="poll-meta">
                            <span>${opt}</span>
                            <span>${count} (${Math.round(percent)}%)</span>
                        </div>
                        <div class="poll-bar-bg"><div class="poll-bar-fill" style="width: ${percent}%"></div></div>
                    </div>
                `;
                container.appendChild(wrapper);
            });
        }

        function renderWordCloud(responses) {
            const container = document.getElementById('wordcloud-results');
            container.innerHTML = '';
            const words = responses.map(r => r.content);

            const freq = {};
            words.forEach(w => freq[w] = (freq[w] || 0) + 1);

            Object.keys(freq).forEach(word => {
                const span = document.createElement('span');
                span.className = 'cloud-word';
                span.innerText = word;
                const size = 1 + (freq[word] * 0.2);
                span.style.fontSize = `${Math.min(size, 3)}rem`;
                container.appendChild(span);
            });
        }

        function renderBlocklist(list) {
            const container = document.getElementById('blocklist-container');
            container.innerHTML = '';
            list.forEach(word => {
                const span = document.createElement('span');
                span.style.padding = '2px 8px';
                span.style.background = '#444';
                span.style.borderRadius = '12px';
                span.style.fontSize = '0.8rem';
                span.style.display = 'flex';
                span.style.alignItems = 'center';
                span.style.gap = '5px';
                span.innerHTML = `${word} <span style="cursor:pointer;color:#aaa;" onclick="removeBlockWord('${word}')">&times;</span>`;
                container.appendChild(span);
            });
        }

        // Actions
        function toggleActive() {
            socket.emit('admin_control', { action: 'toggle_active', value: !currentState.isActive });
        }

        function clearResponses() {
            if (confirm('Clear results for this slide?')) {
                socket.emit('admin_control', { action: 'clear_responses' });
                showToast('Results cleared', 'success');
            }
        }

        function setSlide(index) {
            socket.emit('admin_control', { action: 'set_slide', value: index });
        }

        function prevSlide() {
            const newIndex = Math.max(0, currentState.currentSlideIndex - 1);
            setSlide(newIndex);
        }

        function nextSlide() {
            const newIndex = Math.min(currentState.slides.length - 1, currentState.currentSlideIndex + 1);
            setSlide(newIndex);
        }

        function focusAddSlide() {
            const input = document.getElementById('new-question');
            input.scrollIntoView({ behavior: 'smooth' });
            input.focus();
        }

        function submitNewSlide() {
            const question = document.getElementById('new-question').value;
            const type = document.getElementById('new-type').value;

            if (!question) return showToast('Enter a question', 'error');

            let options = {};
            if (type === 'poll') {
                const inputs = document.querySelectorAll('.poll-option-input');
                let hasOptions = false;
                inputs.forEach(input => {
                    const val = input.value.trim();
                    if (val) {
                        options[val] = 0;
                        hasOptions = true;
                    }
                });
                if (!hasOptions) return showToast('Add at least one poll option', 'error');
            }

            socket.emit('admin_control', {
                action: 'add_slide',
                value: { type, question, options }
            });

            document.getElementById('new-question').value = '';
            // Reset poll options
            document.getElementById('poll-options-list').innerHTML = `
                <input type="text" class="poll-option-input" placeholder="Option 1" style="margin-bottom: 5px;">
                <input type="text" class="poll-option-input" placeholder="Option 2" style="margin-bottom: 5px;">
            `;
            if (type === 'poll') {
                // Keep poll selected or reset? Let's keep it but maybe clear inputs
            }

            showToast('Slide added', 'success');
        }

        function deleteSlide(index) {
            if (confirm('Are you sure you want to delete this slide?')) {
                socket.emit('admin_control', { action: 'delete_slide', value: index });
            }
        }

        function moveSlide(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < currentState.slides.length) {
                socket.emit('admin_control', {
                    action: 'reorder_slides',
                    value: { fromIndex: index, toIndex: newIndex }
                });
            }
        }

        function addBlockWord() {
            const input = document.getElementById('block-input');
            const word = input.value.trim();
            if (word) {
                socket.emit('admin_update_blocklist', { action: 'add', word });
                input.value = '';
                showToast('Word blocked', 'success');
            }
        }

        function removeBlockWord(word) {
            socket.emit('admin_update_blocklist', { action: 'remove', word });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.className = `show ${type}`;
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }
    </script>
</body>

</html>